<!-- frontend/pages/profilo.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profilo – Artigianato Online</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container my-5">
    <h1 class="mb-4">Il mio Profilo</h1>
    <div id="profile-alert" class="alert alert-danger d-none"></div>

    <!-- Form profiling -->
    <form id="profile-form" class="mb-5 needs-validation" novalidate>
      <div class="mb-3">
        <label for="name" class="form-label">Nome</label>
        <input type="text" class="form-control" id="name" name="name" required minlength="2" />
        <div class="invalid-feedback">Inserisci il tuo nome (minimo 2 caratteri).</div>
      </div>
      <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" id="email" name="email" required />
        <div class="invalid-feedback">Inserisci un’email valida.</div>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Nuova Password <small class="text-muted">(opzionale)</small></label>
        <input type="password" class="form-control" id="password" name="password" minlength="6" />
        <div class="invalid-feedback">La password deve essere almeno di 6 caratteri.</div>
      </div>
      <button type="submit" class="btn btn-primary">Aggiorna Profilo</button>
    </form>

    <hr />

    <h2 class="mt-5">Cronologia Ordini</h2>
    <div class="table-responsive mt-3">
      <table id="orders-history-table" class="table table-striped">
        <thead>
          <tr>
            <th>Ordine #</th>
            <th>Data</th>
            <th>Totale</th>
            <th>Stato</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Bootstrap & jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(function() {
      const token = sessionStorage.getItem('authToken');
      if (!token) return window.location.href = '/login.html';

      const $alert = $('#profile-alert');
      const $form = $('#profile-form')[0];
      const $ordersTbody = $('#orders-history-table tbody');

      function showError(msg) {
        $alert.text(msg).removeClass('d-none');
      }

      // Carica dati profilo
      function loadProfile() {
        $.ajax({
          url: '/api/user/profile',
          headers: { Authorization: 'Bearer ' + token },
          success: res => {
            $('#name').val(res.name);
            $('#email').val(res.email);
          },
          error: xhr => showError(xhr.responseJSON?.message || 'Errore caricamento profilo.')
        });
      }

      // Aggiornamento profilo
      $('#profile-form').on('submit', function(e) {
        e.preventDefault();
        $form.classList.add('was-validated');
        if (!$form.checkValidity()) return;

        const payload = {
          name: $('#name').val(),
          email: $('#email').val()
        };
        const newPass = $('#password').val();
        if (newPass) payload.password = newPass;

        $.ajax({
          url: '/api/user/profile',
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify(payload),
          headers: { Authorization: 'Bearer ' + token },
          success: () => {
            alert('Profilo aggiornato con successo.');
            $('#password').val('');
          },
          error: xhr => showError(xhr.responseJSON?.message || 'Aggiornamento fallito.')
        });
      });

      // Carica cronologia ordini
      function loadOrders() {
        $.ajax({
          url: '/api/user/orders',
          headers: { Authorization: 'Bearer ' + token },
          success: res => {
            $ordersTbody.empty();
            $.get('/components/order-row.html', tpl => {
              res.forEach(o => {
                const rowHtml = tpl
                  .replace(/{{id}}/g, o.id)
                  .replace(/{{date}}/g, new Date(o.createdAt).toLocaleDateString())
                  .replace(/{{total}}/g, o.total.toFixed(2))
                  .replace(/{{status}}/g, o.status);
                const $row = $(rowHtml).appendTo($ordersTbody);
                $(document).trigger('loadOrderRow', [$row]);
              });
            });
          },
          error: xhr => showError(xhr.responseJSON?.message || 'Errore caricamento cronologia ordini.')
        });
      }

      loadProfile();
      loadOrders();
    });
  </script>
</body>
</html>
