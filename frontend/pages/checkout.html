<!-- frontend/pages/checkout.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout – Artigianato Online</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">

  <div class="container my-5">
    <h1 class="mb-4">Checkout</h1>

    <div id="checkout-alert" class="alert alert-danger d-none"></div>

    <div id="order-summary" class="mb-4">
      <!-- Riepilogo carrello -->
    </div>

    <form id="checkout-form">
      <div class="mb-3">
        <label for="address" class="form-label">Indirizzo di spedizione</label>
        <input type="text" class="form-control" id="address" name="address" required />
        <div class="invalid-feedback">Inserisci l'indirizzo.</div>
      </div>
      <div class="mb-3">
        <label for="paymentMethod" class="form-label">Metodo di pagamento</label>
        <select class="form-select" id="paymentMethod" name="paymentMethod" required>
          <option value="">Seleziona...</option>
          <option value="credit_card">Carta di credito</option>
          <option value="paypal">PayPal</option>
        </select>
        <div class="invalid-feedback">Seleziona un metodo di pagamento.</div>
      </div>
      <button type="submit" class="btn btn-success">Conferma ordine</button>
    </form>
  </div>

  <!-- Bootstrap & jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    $(document).ready(function() {
      const token = sessionStorage.getItem('authToken');
      if (!token) return window.location.href = '/login.html';

      const $alert = $('#checkout-alert');
      const $order = $('#order-summary');
      const $form = $('#checkout-form')[0];

      function showError(msg) {
        $alert.text(msg).removeClass('d-none');
      }

      function loadSummary() {
        $.ajax({
          url: '/api/cart',
          method: 'GET',
          headers: { Authorization: 'Bearer ' + token },
          success: renderSummary,
          error: xhr => showError(xhr.responseJSON?.message || 'Errore caricamento riepilogo.')
        });
      }

      function renderSummary(items) {
        let total = 0;
        let html = '<ul class="list-group mb-3">';
        items.forEach(item => {
          const subtotal = item.price * item.quantity;
          total += subtotal;
          html += `
            <li class="list-group-item d-flex justify-content-between">
              <div>
                <strong>${item.name}</strong><br>
                <small>Quantità: ${item.quantity}</small>
              </div>
              <span>€${subtotal.toFixed(2)}</span>
            </li>`;
        });
        html += `<li class="list-group-item d-flex justify-content-between"><strong>Totale</strong><strong>€${total.toFixed(2)}</strong></li>`;
        html += '</ul>';
        $order.html(html);
      }

      $('#checkout-form').on('submit', function(e) {
        e.preventDefault();
        $form.classList.add('was-validated');
        if (!$form.checkValidity()) return;

        const payload = {
          address: $('#address').val(),
          paymentMethod: $('#paymentMethod').val()
        };

        $.ajax({
          url: '/api/orders',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(payload),
          headers: { Authorization: 'Bearer ' + token },
          success: function(res) {
            window.location.href = `/pages/ordine.html?id=${res.orderId}`;
          },
          error: xhr => showError(xhr.responseJSON?.message || 'Checkout fallito.')
        });
      });

      loadSummary();
    });
  </script>
</body>
</html>
