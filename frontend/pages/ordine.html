<!-- frontend/pages/ordine.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dettaglio Ordine – Artigianato Online</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">

  <div class="container my-5">
    <h1 class="mb-4">Dettagli dell'Ordine</h1>

    <div id="order-alert" class="alert alert-danger d-none"></div>

    <div id="order-info" class="mb-4">
      <!-- Info ordine -->
    </div>

    <div id="order-items" class="mb-4">
      <!-- Lista articoli -->
    </div>

    <div id="order-actions" class="mb-4">
      <!-- Pulsanti / stato -->
    </div>
  </div>

  <!-- Bootstrap & jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    $(function() {
      const token = sessionStorage.getItem('authToken');
      if (!token) return window.location.href = '/login.html';

      const $alert = $('#order-alert');
      const $info = $('#order-info');
      const $items = $('#order-items');
      const $actions = $('#order-actions');
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) {
        $alert.text('ID ordine mancante.').removeClass('d-none');
        return;
      }

      function showError(msg) { $alert.text(msg).removeClass('d-none'); }

      function loadOrder() {
        $.ajax({
          url: `/api/orders/${id}`,
          headers: { Authorization: 'Bearer ' + token },
          success: renderOrder,
          error: xhr => showError(xhr.responseJSON?.message || 'Errore caricamento ordine.')
        });
      }

      function renderOrder(o) {
        // Informazioni generali
        $info.html(`
          <p><strong>Ordine #${o.id}</strong> – ${new Date(o.createdAt).toLocaleString()}</p>
          <p><strong>Cliente:</strong> ${o.customerName}<br>
             <strong>Indirizzo:</strong> ${o.address}<br>
             <strong>Metodo di pagamento:</strong> ${o.paymentMethod.replace('_', ' ')}</p>
        `);

        // Articoli
        let total = 0;
        let list = `<ul class="list-group mb-3">`;
        o.items.forEach(it => {
          const subtotal = it.price * it.quantity;
          total += subtotal;
          list += `
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <strong>${it.name}</strong><br>
                <small>Quantità: ${it.quantity}</small>
              </div>
              <span>€${subtotal.toFixed(2)}</span>
            </li>`;
        });
        list += `<li class="list-group-item d-flex justify-content-between"><strong>Totale</strong><strong>€${total.toFixed(2)}</strong></li>`;
        list += `</ul>`;
        $items.html(list);

        // Stato & azioni
        const status = o.status;
        let actionsHtml = `<p><strong>Stato:</strong> ${status}</p>`;
        if (o.isSeller) {
          if (status === 'PENDING') {
            actionsHtml += `<button id="confirm-btn" class="btn btn-success me-2">Conferma</button>
                            <button id="cancel-btn" class="btn btn-danger">Annulla</button>`;
          }
        } else {
          if (status === 'PENDING') {
            actionsHtml += `<p class="text-muted">L\'artigiano deve ancora confermare.</p>`;
          }
        }

        $actions.html(actionsHtml);

        // Eventi seller
        $('#confirm-btn').on('click', function() {
          $.ajax({
            url: `/api/seller/orders/${id}/confirm`,
            method: 'POST',
            headers: { Authorization: 'Bearer ' + token },
            success: loadOrder,
            error: xhr => showError(xhr.responseJSON?.message || 'Impossibile confermare.')
          });
        });
        $('#cancel-btn').on('click', function() {
          $.ajax({
            url: `/api/orders/${id}/cancel`,
            method: 'POST',
            headers: { Authorization: 'Bearer ' + token },
            success: loadOrder,
            error: xhr => showError(xhr.responseJSON?.message || 'Impossibile annullare.')
          });
        });
      }

      loadOrder();
    });
  </script>
</body>
</html>
