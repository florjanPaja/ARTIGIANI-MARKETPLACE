<!-- frontend/pages/dashboard.html -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard – Artigianato Online</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav id="sidebar" class="col-md-2 d-none d-md-block bg-white border-end vh-100">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" href="#">Prodotti</a></li>
            <li class="nav-item"><a class="nav-link" href="#order-management">Ordini</a></li>
            <li class="nav-item"><a id="logout-btn" class="nav-link text-danger" href="#">Logout</a></li>
          </ul>
        </div>
      </nav>

      <!-- Main content -->
      <main class="col-md-10 ms-sm-auto px-4 py-4">
        <h1 class="h2 mb-4">Dashboard Artigiano</h1>
        <div id="dash-alert" class="alert alert-danger d-none"></div>

        <!-- Sezione Prodotti -->
        <section id="product-management" class="mb-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Prodotti</h3>
            <button id="add-product-btn" class="btn btn-primary">Aggiungi Prodotto</button>
          </div>
          <div class="table-responsive">
            <table id="products-table" class="table table-striped">
              <thead>
                <tr><th>ID</th><th>Nome</th><th>Prezzo</th><th>Disponibilità</th><th>Azioni</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- Sezione Ordini -->
        <section id="order-management" class="mt-5">
          <h3>Ordini Ricevuti</h3>
          <div class="table-responsive">
            <table id="orders-table" class="table table-striped">
              <thead><tr><th>Ordine #</th><th>Data</th><th>Totale</th><th>Stato</th><th>Azioni</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Librerie -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(function(){
      const token = sessionStorage.getItem('authToken');
      if (!token) return window.location.href = '/login.html';

      const $alert = $('#dash-alert');
      const $productsTbody = $('#products-table tbody');
      const $ordersTbody = $('#orders-table tbody');

      function showError(msg) {
        $alert.text(msg).removeClass('d-none');
      }

      // Logout
      $('#logout-btn').on('click', e => {
        e.preventDefault();
        sessionStorage.removeItem('authToken');
        window.location.href = '/login.html';
      });

      // Load prodotti
      function loadProducts() {
        $.ajax({
          url: '/api/seller/products',
          headers: {'Authorization': 'Bearer ' + token},
          success: res => {
            $productsTbody.empty();
            res.forEach(p => {
              $productsTbody.append(
                `<tr data-id="${p.id}">
                  <td>${p.id}</td>
                  <td>${p.name}</td>
                  <td>€${p.price.toFixed(2)}</td>
                  <td>${p.available ? '✅' : '❌'}</td>
                  <td>
                    <button class="btn btn-sm btn-warning edit-btn">Modifica</button>
                    <button class="btn btn-sm btn-danger del-btn">Elimina</button>
                  </td>
                </tr>`
              );
            });
          },
          error: xhr => showError(xhr.responseJSON?.message || 'Impossibile caricare prodotti.')
        });
      }

      // Eventi prodotti
      $('#products-table')
        .on('click', '.edit-btn', function() {
          window.location.href = `/pages/prodotto.html?id=${$(this).closest('tr').data('id')}&edit=true`;
        })
        .on('click', '.del-btn', function() {
          const id = $(this).closest('tr').data('id');
          if (!confirm('Confermi eliminazione?')) return;
          $.ajax({
            url: `/api/seller/products/${id}`,
            method: 'DELETE',
            headers: {'Authorization': 'Bearer ' + token},
            success: loadProducts,
            error: xhr => showError(xhr.responseJSON?.message || 'Eliminazione fallita.')
          });
        });

      $('#add-product-btn').on('click', () => window.location.href = '/pages/prodotto.html');

      // Load ordini con order-row component
      function loadOrders() {
        $.ajax({
          url: '/api/seller/orders',
          headers: {'Authorization': 'Bearer ' + token},
          success: res => {
            $ordersTbody.empty();
            $.get('/components/order-row.html', tpl => {
              res.forEach(o => {
                const html = tpl
                  .replace(/{{id}}/g, o.id)
                  .replace(/{{date}}/g, new Date(o.createdAt).toLocaleDateString())
                  .replace(/{{total}}/g, o.total.toFixed(2))
                  .replace(/{{status}}/g, o.status);
                const $row = $(html).appendTo($ordersTbody);
                $(document).trigger('loadOrderRow', [$row]);
              });
            });
          },
          error: xhr => showError(xhr.responseJSON?.message || 'Impossibile caricare ordini.')
        });
      }

      // Inizializza tutto
      loadProducts();
      loadOrders();
    });
  </script>
</body>
</html>
