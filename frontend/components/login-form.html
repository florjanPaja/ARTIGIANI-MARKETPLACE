<!-- frontend/components/login-form.html -->
<style>
    /* Evitiamo duplicazione stilistica, ma puoi spostarlo in css globale */
    .modal-backdrop.show { opacity: 0.5; }
  </style>
  
  <div class="card shadow-sm mx-auto" style="max-width: 400px;">
    <div class="card-header text-center">
      <h4>Login</h4>
    </div>
    <div class="card-body">
      <form id="login-form" novalidate>
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" name="email" required>
          <div class="invalid-feedback">Inserisci un'email valida.</div>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Password</label>
          <input type="password" class="form-control" id="password" name="password" required minlength="6">
          <div class="invalid-feedback">La password deve avere almeno 6 caratteri.</div>
        </div>
        <div id="login-error" class="text-danger mb-2" style="display:none;"></div>
        <div class="d-grid mb-2">
          <button type="submit" class="btn btn-primary">Accedi</button>
        </div>
        <div class="text-center">
          <a href="#" id="forgot-password-link">Password dimenticata?</a>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Modal password dimenticata -->
  <div class="modal fade" id="forgot-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="forgot-form" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Recupera password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="forgot-error" class="text-danger mb-2" style="display:none;"></div>
            <div id="forgot-success" class="text-success mb-2" style="display:none;"></div>
            <div class="mb-3">
              <label for="forgot-email" class="form-label">Email</label>
              <input type="email" class="form-control" id="forgot-email" name="email" required>
              <div class="invalid-feedback">Inserisci la tua email.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
            <button type="submit" class="btn btn-primary">Invia email</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    $(function() {
      // redirect se giÃ  loggato
      const token = sessionStorage.getItem('authToken');
      if (token) {
        window.location.href = '/';
        return;
      }
  
      $('#login-form').on('submit', function(e) {
        e.preventDefault();
        this.classList.add('was-validated');
        if (!this.checkValidity()) return;
  
        const payload = { email: $('#email').val(), password: $('#password').val() };
        $.ajax({
          url: '/api/auth/login', method: 'POST', contentType: 'application/json',
          data: JSON.stringify(payload),
          success: res => {
            sessionStorage.setItem('authToken', res.token);
            window.location.href = '/';
          },
          error: xhr => {
            $('#login-error').text(xhr.responseJSON?.message || 'Credenziali non valide').show();
          }
        });
      });
  
      const forgotModal = new bootstrap.Modal($('#forgot-modal')[0]);
      $('#forgot-password-link').on('click', e => {
        e.preventDefault();
        $('#forgot-form')[0].reset();
        $('#forgot-error,#forgot-success').hide();
        $('#forgot-form')[0].classList.remove('was-validated');
        forgotModal.show();
      });
  
      $('#forgot-form').on('submit', function(e) {
        e.preventDefault();
        this.classList.add('was-validated');
        if (!this.checkValidity()) return;
  
        const email = $('#forgot-email').val();
        $.ajax({
          url: '/api/auth/forgot-password', method: 'POST',
          contentType: 'application/json', data: JSON.stringify({ email }),
          success: () => {
            $('#forgot-success').text('Email inviata se registrata').show();
            $('#forgot-error').hide();
          },
          error: xhr => {
            $('#forgot-error').text(xhr.responseJSON?.message || 'Errore invio email').show();
            $('#forgot-success').hide();
          }
        });
      });
    });
  </script>
  